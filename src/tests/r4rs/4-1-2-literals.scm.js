input = "&epyt-erudecorp,epyt-riap,epyt-rotcev,epyt-gnirts,epyt-rahc,epyt-lobmys,foe##,trop-tuodts,epyt-trop-tuptuo,rorre,rahc-etirw,tixe##,enilwen,tuodts##,?bir##,?lobmys,*##,gnirts>-lobmys,?rahc,trop-tuptuo-tnerruc,?tcejbo-foe,?regetni,?erudecorp,?rotcev,gnirts>-rebmun,tneitouq##,?llun,esolc##,?ecnatsni,?riap,?gnirts,tsil-etirw,etirw,htgnel,+##,2gra##,2dleif##,-##,srahc-etirw,yalpsid,di##,hsarc,xua-gnirts>-rebmun,<##,1dleif##,?vqe##,0dleif##,rahc-etirw##,1gra##,,,,bir##;8Mlj,!1/li$1maBl_>m?ma^@l^~Ql^}'!887m`^>mKm?m_vC>m?m_vR#>m?m_vC@l_/li$~Tl^88m`Bl^>mNm`@l^>m?m@l`vC~Ql^}'!0.k(m_vS7>m?m_vF~YAl`(m_vL>mKmOmaBl^>mNma@l^@l`>m?m_vK>m?m_vF~Wl`1m_@l`~Pl`1m_@lYFl`~YHl`(m_vL>mOm`Bl`>mNm`@l`>m?m_vK~Ql`(m_`~YEl`0m`Vl`~YBl`(m_vL>m?m_vK~Tl`0m`j*~YCl`(m_vS;>m?m_vF~Ami%`(m_vS->m?m_vF~Ami$`@l^>mi$.k(m_vS7>m?m_vF~YAl`(m_vL>mKmOmaBl^>mNma@l^@l`>m?m_vK>m?m_vF~Wl`1m_@l`~Pl`1m_@lYFl`~YHl`(m_vL>mOm`Bl`>mNm`@l`>m?m_vK~Ql`(m_`~YEl`0m`Vl`~YBl`(m_vL>m?m_vK~Tl`0m`j*~YCl`(m_vS;>m?m_vF~Ami%`(m_vS->m?m_vF~Ami$`@l^>mEk~AmkJl`Km^[&Bl`@l_.k(m_vS7>m?m_vF~YAl`(m_vL>mKmOmaBl^>mNma@l^@l`>m?m_vK>m?m_vF~Wl`1m_@l`~Pl`1m_@lYFl`~YHl`(m_vL>mOm`Bl`>mNm`@l`>m?m_vK~Ql`(m_`~YEl`0m`Vl`~YBl`(m_vL>m?m_vK~Tl`0m`j*~YCl`(m_vS;>m?m_vF~Ami%`(m_vS->m?m_vF~Ami$`@l^>mi$.k(m_vS7>m?m_vF~YAl`(m_vL>mKmOmaBl^>mNma@l^@l`>m?m_vK>m?m_vF~Wl`1m_@l`~Pl`1m_@lYFl`~YHl`(m_vL>mOm`Bl`>mNm`@l`>m?m_vK~Ql`(m_`~YEl`0m`Vl`~YBl`(m_vL>m?m_vK~Tl`0m`j*~YCl`(m_vS;>m?m_vF~Ami%`(m_vS->m?m_vF~Ami$`@l^>mEk~AmkJl`YDk~Ami&_|!70m__(m_vE>mHm_@l`>m?m_vE@l^~Pl_>mi$0m__(m_vE>mHm_@l`>m?m_vE@l^~Pl_>mEk~AmkJl`Km^[&Bl`@l_0m__(m_vE>mHm_@l`>m?m_vE@l^~Pl_>mi$0m__(m_vE>mHm_@l`>m?m_vE@l^~Pl_>mEk~AmkJl`YDk~Ami&_|!K(m@l_u>mi$(m@l_u>mEk~AmkJl_Km^[%Bl_@l^(m@l_u>mi$(m@l_u>mEk~AmkJl_YDk~Ami&^z!M(m@l_@l_>mi$(m@l_@l_>mEk~AmkJl`Km^[&Bl`@l_(m@l_@l_>mi$(m@l_@l_>mEk~AmkJl`YDk~Ami&_|!D/liPy!P:nti%YJk!C*mj#^{]#:npkk!Ot!(:nlkl!J:nlkm!6/lk5mMlBl_l~Ql^{!?#nnMl_^Dmi&_#nnMl_^:nkDmi&ImakvP~Cmk_!-Sl/l^-m_`~Cmak:nkbLm_vR%/l^-m_`~Cmak:nkbLmImu_vR6~Cm_tImYGme__Umc^}'>mi$#nnMl_^Dmi&_#nnMl_^:nkDmi&ImakvP~Cmk_!-Sl/l^-m_`~Cmak:nkbLm_vR%/l^-m_`~Cmak:nkbLmImu_vR6~Cm_tImYGme__Umc^}'>mEk~AmkJl`Km^[&Bl`@l_#nnMl_^Dmi&_#nnMl_^:nkDmi&ImakvP~Cmk_!-Sl/l^-m_`~Cmak:nkbLm_vR%/l^-m_`~Cmak:nkbLmImu_vR6~Cm_tImYGme__Umc^}'>mi$#nnMl_^Dmi&_#nnMl_^:nkDmi&ImakvP~Cmk_!-Sl/l^-m_`~Cmak:nkbLm_vR%/l^-m_`~Cmak:nkbLmImu_vR6~Cm_tImYGme__Umc^}'>mEk~AmkJl`u~Ami&_|!F+l^{!6/lk5mMlBl_l~Ql^{!B*mi$YIl^{!=*mi&^{!ERlq!ARll!@Rlo!9Rln!HRlm!:Rlk!;8<l/li$*mbJl^~YIl^{{]%q]'o]&n]$m])l](k!.8Nlj+y!N8Lll>mYKk>mGl^{!/:nlkn!':nlko!4:nlkp!<:nlkq!I:nlkr!):nlks!+:nlkt!3:nlku!*:nlkv.!,:nlkv/!5:nlkv0!G:nlkv2!>:nlkv3!L:nlkv4],:nqkvR6]*:nnp:nk:nk:nk:nk:nki&vS-vS6vS,vDvF]+:nnq:nk:nk:nk:nk:nk:nki&vLvJvR#vS&vR#vK!2:nlkv1{"; // @@(replace "&epyt-erudecorp,epyt-riap,epyt-rotcev,epyt-gnirts,epyt-rahc,epyt-lobmys,foe##,trop-tuodts,epyt-trop-tuptuo,rorre,rahc-etirw,tixe##,enilwen,tuodts##,?bir##,?lobmys,*##,gnirts>-lobmys,?rahc,trop-tuptuo-tnerruc,?tcejbo-foe,?regetni,?erudecorp,?rotcev,gnirts>-rebmun,tneitouq##,?llun,esolc##,?ecnatsni,?riap,?gnirts,tsil-etirw,etirw,htgnel,+##,2gra##,2dleif##,-##,srahc-etirw,yalpsid,di##,hsarc,xua-gnirts>-rebmun,<##,1dleif##,?vqe##,0dleif##,rahc-etirw##,1gra##,,,,bir##;8Mlj,!1/li$1maBl_>m?ma^@l^~Ql^}'!887m`^>mKm?m_vC>m?m_vR#>m?m_vC@l_/li$~Tl^88m`Bl^>mNm`@l^>m?m@l`vC~Ql^}'!0.k(m_vS7>m?m_vF~YAl`(m_vL>mKmOmaBl^>mNma@l^@l`>m?m_vK>m?m_vF~Wl`1m_@l`~Pl`1m_@lYFl`~YHl`(m_vL>mOm`Bl`>mNm`@l`>m?m_vK~Ql`(m_`~YEl`0m`Vl`~YBl`(m_vL>m?m_vK~Tl`0m`j*~YCl`(m_vS;>m?m_vF~Ami%`(m_vS->m?m_vF~Ami$`@l^>mi$.k(m_vS7>m?m_vF~YAl`(m_vL>mKmOmaBl^>mNma@l^@l`>m?m_vK>m?m_vF~Wl`1m_@l`~Pl`1m_@lYFl`~YHl`(m_vL>mOm`Bl`>mNm`@l`>m?m_vK~Ql`(m_`~YEl`0m`Vl`~YBl`(m_vL>m?m_vK~Tl`0m`j*~YCl`(m_vS;>m?m_vF~Ami%`(m_vS->m?m_vF~Ami$`@l^>mEk~AmkJl`Km^[&Bl`@l_.k(m_vS7>m?m_vF~YAl`(m_vL>mKmOmaBl^>mNma@l^@l`>m?m_vK>m?m_vF~Wl`1m_@l`~Pl`1m_@lYFl`~YHl`(m_vL>mOm`Bl`>mNm`@l`>m?m_vK~Ql`(m_`~YEl`0m`Vl`~YBl`(m_vL>m?m_vK~Tl`0m`j*~YCl`(m_vS;>m?m_vF~Ami%`(m_vS->m?m_vF~Ami$`@l^>mi$.k(m_vS7>m?m_vF~YAl`(m_vL>mKmOmaBl^>mNma@l^@l`>m?m_vK>m?m_vF~Wl`1m_@l`~Pl`1m_@lYFl`~YHl`(m_vL>mOm`Bl`>mNm`@l`>m?m_vK~Ql`(m_`~YEl`0m`Vl`~YBl`(m_vL>m?m_vK~Tl`0m`j*~YCl`(m_vS;>m?m_vF~Ami%`(m_vS->m?m_vF~Ami$`@l^>mEk~AmkJl`YDk~Ami&_|!70m__(m_vE>mHm_@l`>m?m_vE@l^~Pl_>mi$0m__(m_vE>mHm_@l`>m?m_vE@l^~Pl_>mEk~AmkJl`Km^[&Bl`@l_0m__(m_vE>mHm_@l`>m?m_vE@l^~Pl_>mi$0m__(m_vE>mHm_@l`>m?m_vE@l^~Pl_>mEk~AmkJl`YDk~Ami&_|!K(m@l_u>mi$(m@l_u>mEk~AmkJl_Km^[%Bl_@l^(m@l_u>mi$(m@l_u>mEk~AmkJl_YDk~Ami&^z!M(m@l_@l_>mi$(m@l_@l_>mEk~AmkJl`Km^[&Bl`@l_(m@l_@l_>mi$(m@l_@l_>mEk~AmkJl`YDk~Ami&_|!D/liPy!P:nti%YJk!C*mj#^{]#:npkk!Ot!(:nlkl!J:nlkm!6/lk5mMlBl_l~Ql^{!?#nnMl_^Dmi&_#nnMl_^:nkDmi&ImakvP~Cmk_!-Sl/l^-m_`~Cmak:nkbLm_vR%/l^-m_`~Cmak:nkbLmImu_vR6~Cm_tImYGme__Umc^}'>mi$#nnMl_^Dmi&_#nnMl_^:nkDmi&ImakvP~Cmk_!-Sl/l^-m_`~Cmak:nkbLm_vR%/l^-m_`~Cmak:nkbLmImu_vR6~Cm_tImYGme__Umc^}'>mEk~AmkJl`Km^[&Bl`@l_#nnMl_^Dmi&_#nnMl_^:nkDmi&ImakvP~Cmk_!-Sl/l^-m_`~Cmak:nkbLm_vR%/l^-m_`~Cmak:nkbLmImu_vR6~Cm_tImYGme__Umc^}'>mi$#nnMl_^Dmi&_#nnMl_^:nkDmi&ImakvP~Cmk_!-Sl/l^-m_`~Cmak:nkbLm_vR%/l^-m_`~Cmak:nkbLmImu_vR6~Cm_tImYGme__Umc^}'>mEk~AmkJl`u~Ami&_|!F+l^{!6/lk5mMlBl_l~Ql^{!B*mi$YIl^{!=*mi&^{!ERlq!ARll!@Rlo!9Rln!HRlm!:Rlk!;8<l/li$*mbJl^~YIl^{{]%q]'o]&n]$m])l](k!.8Nlj+y!N8Lll>mYKk>mGl^{!/:nlkn!':nlko!4:nlkp!<:nlkq!I:nlkr!):nlks!+:nlkt!3:nlku!*:nlkv.!,:nlkv/!5:nlkv0!G:nlkv2!>:nlkv3!L:nlkv4],:nqkvR6]*:nnp:nk:nk:nk:nk:nki&vS-vS6vS,vDvF]+:nnq:nk:nk:nk:nk:nk:nki&vLvJvR#vS&vR#vK!2:nlkv1{" (encode 92))@@



debug = false;
// )@@



lengthAttr = "length";
isNode = process?.versions?.node != null;







// --------------------------------------------------------------

// VM


// build the symbol table

pos = 0;
get_byte = () => input[pos++].charCodeAt(0);
get_code = () => { let x = get_byte()-35; return x<0 ? 57 : x; };
get_int = (n) => { let x = get_code(); n *= 46; return x<46 ? n+x : get_int(n+x-46); };

pop = () => { let x = stack[0]; stack = stack[1]; return x; };

FALSE = [0,0,5]; TRUE = [0,0,5]; NIL = [0,0,5];

symtbl = NIL;
n = get_int(0);
while (n-- > 0) symtbl=[[0,[NIL,0,3],2],symtbl,0]; // symbols with empty names

accum = NIL;
n = 0;
while (1) {
  c = get_byte();
  if (c == 44) { symtbl=[[0,[accum,n,3],2],symtbl,0]; accum = NIL; n = 0; continue; }
  if (c == 59) break;
  accum = [c,accum,0];
  n++;
}

symtbl = [[0,[accum,n,3],2],symtbl,0];

symbol_ref = (n) => list_tail(symtbl,n)[0];
list_tail = (x,i) => i ? list_tail(x[1],i-1) : x;
inst_tail = (x,i) => i ? inst_tail(x[2],i-1) : x;

// decode the instruction graph






stack = 0;

while (1) {
  x = get_code();
  n = x;
  d = 0;
  op = -1;
  while ((d=[20,30,0,10,11,4][++op])+2<n) n -= d+3;
  if (x>90)
    n = pop();
  else {
    if (!op) stack = [0,stack,0];
    n = n>=d ? (n==d ? get_int(0) : symbol_ref(get_int(n-d-1))) : op<3 ? symbol_ref(n) : n;
    if (4<op) {
      n = [[n,0,pop()],0,1];
      if (!stack) break;
      op=4;
    }
  }
  stack[0] = [op?op-1:0,n,stack[0]];
}
// )@@

set_global = (x) => { symtbl[0][0] = x; symtbl = symtbl[1]; };

set_global([0,symtbl,1]); // primitive 0
set_global(FALSE);
set_global(TRUE);
set_global(NIL);

// RVM core

pc = n[0][2];

stack = [0,0,[5,0,0]]; // primordial continuation (executes halt instr.)

push = (x) => ((stack = [x,stack,0]), true);
bool2scm = (x) => x ? TRUE : FALSE;
// )@@



















is_rib = (x) => x[lengthAttr];

get_opnd = (o) => is_rib(o) ? o : list_tail(stack,o);
get_cont = () => { let s = stack; while (!s[2]) s = s[1]; return s; };

prim1 = (f) => () => push(f(pop()));
prim2 = (f) => () => push(f(pop(),pop()));
prim3 = (f) => () => push(f(pop(),pop(),pop()));

primitives = [
  prim3((z, y, x) => [x, y, z]),                    //  @@(primitive (##rib a b c))@@
prim2((fd, ch) => fs.writeSync(fd, String.fromCodePoint(ch), null, 'utf8')),() => push(1),  prim1((x) => x),                                  //  @@(primitive (##id x))@@
  () => (pop(), true),                              //  @@(primitive (##arg1 x y))@@
  () => push([pop(),pop()][0]),                     //  @@(primitive (##arg2 x y))@@
  () => push([pop()[0],stack,1]),                   //  @@(primitive (##close rib))@@
  prim1((x) => bool2scm(is_rib(x))),             //  @@(primitive (##rib? rib) (use bool2scm))@@
  prim1((x) => x[0]),                               //  @@(primitive (##field0 rib))@@
  prim1((x) => x[1]),                               //  @@(primitive (##field1 rib))@@
  prim1((x) => x[2]),                               //  @@(primitive (##field2 rib))@@
  prim2((y, x) => bool2scm(x===y)),              //  @@(primitive (##eqv? x y) (use bool2scm))@@
  prim2((y, x) => bool2scm(x<y)),                //  @@(primitive (##< x y) (use bool2scm))@@
  prim2((y, x) => x+y),                             //  @@(primitive (##+ x y))@@
  prim2((y, x) => x-y),                             //  @@(primitive (##- x y))@@
  prim2((y, x) => x*y),                             //  @@(primitive (##* x y))@@
  prim2((y, x) => x/y|0),                           //  @@(primitive (##quotient x y))@@
  () => pop() && halt(),//will crash with error on != 0 @@(primitive (##exit n))@@
];

run = () => {
  while (1) {
    let o = pc[1];
    switch (pc[0]) {
    case 5: // halt
        return;
    case 0: // jump/call
        o = get_opnd(o)[0];
        while(1) {
            if (debug) { console.log((pc[2]===0 ? "--- jump " : "--- call ") + show_opnd(o)); show_stack(); } //debug
            let c = o[0];

            if (is_rib(c)) {
                let nargs=pop();
                // )@@

                let c2 = [0,o,0];
                let s2 = c2;


                let nparams = c[0] >> 1; 
                if (c[0] & 1 ? nparams > nargs : nparams != nargs){
                    console.log("*** Unexpected number of arguments nargs:", nargs, " nparams:", nparams, "variadics:", c[0]&1);
                    halt();
                }
                // )@@

                nargs-=nparams;
                if (c[0]&1) {
                    let rest=NIL;
                    while(nargs--) 
                        rest=[pop(), rest, 0];
                    s2=[rest,s2,0]
                }
                // )@@
                while (nparams--) s2 = [pop(),s2,0];

                if (pc[2]===0) {
                    // jump
                    let k = get_cont();
                    c2[0] = k[0];
                    c2[2] = k[2];
                } else {
                    // call
                    c2[0] = stack;
                    c2[2] = pc[2];
                }
                stack = s2;
            } else {
                pop()
                // )@@

                o=primitives[c]()
                if (!o) return;
                if (is_rib(o)) continue;
                if (pc[2]===0) {
                    // jump
                    c = get_cont();
                    stack[1] = c[0];
                } else {
                    // call
                    c = pc;
                }
            }
            pc = c;
            break;
        }
        break;
    case 1: // set
        if (debug) { console.log("--- set " + show_opnd(o)); show_stack(); } //debug
        get_opnd(o)[0] = pop();
        break;
    case 2: // get
        if (debug) { console.log("--- get " + show_opnd(o)); show_stack(); } //debug
        push(get_opnd(o)[0]);
        break;
    case 3: // const
        if (debug) { console.log("--- const " + (is_rib(o) ? "" : ("int " + o))); show_stack(); } //debug
        push(o);
        break;
    case 4: // if
        if (debug) { console.log("--- if"); show_stack(); } //debug
        if (pop() !== FALSE) { pc = pc[1]; continue; }
        break;
    }
      pc = pc[2];
  }
};

if (isNode) run();
